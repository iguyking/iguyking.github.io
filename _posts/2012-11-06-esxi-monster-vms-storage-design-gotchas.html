---
layout: post
status: publish
published: true
title: Monster VMs Mass Storage & How to check storage used
author:
  display_name: iguy
  login: iguy
  email: iguy@ionsphere.org
  url: ''
author_login: iguy
author_email: iguy@ionsphere.org
wordpress_id: 712
wordpress_url: http://itsjustanotherlayer.com/?p=712
date: !binary |-
  MjAxMi0xMS0wNiAyMjo1MDozNyAtMDYwMA==
date_gmt: !binary |-
  MjAxMi0xMS0wNyAwNDo1MDozNyAtMDYwMA==
categories:
- VMware
tags:
- esxi
- PowerCLI
- scripts
- monsterVM
comments: []
---
<p>Jason Boche posted an <a title="ESXi Heap Size" href="http://www.boche.net/blog/index.php/2012/09/12/monster-vms-esxi-heap-size-trouble-in-storage-paradise/">interesting discovery</a> with regards to Monster VMs and the amount of storage one would be sticking to them.  One of the large projects being designed today  has the likely reason to hit this limit with just a single VM.  This is pretty easy for that project to hit that as a single VM will have about 75TB assigned to it.   Since this design has 4 or 5 VMs of this size, which then means our standard ESXi Host will have around 300+ TB assigned to it.  Thankfully RDM isn't impacted by this limit in theory, so there is a workaround available.  Not ideal and yet doable.</p>
<p>Instead one of the questions that came out of this news is "Does this issue impact the rest of our environment?"   Will this explain some random stability issues we have seen?</p>
<p>This script will return what every single host has in terms of VMDK files.  To use this script look at each host and see if the host itself is under the limits.  Then look at the cluster level based on the HA rules and see what the VMDK limits would be if a host failed.  That should give an idea of how close your clusters might be to hitting this limit.</p>
<pre lang="Powershell" line="1">
if ( -not (Get-PSSnapIn | where {$_.Name -eq "VMware.VimAutomation.Core"}) )<br />
{<br />
    Add-PSSnapin -Name "VMware.VimAutomation.Core"<br />
}</p>
<p>$vcenters = "vCenter"</p>
<p>connect-viserver -server $vcenters -cred (Get-Credential)</p>
<p>$diskuse = @()</p>
<p>$clusters = get-cluster<br />
foreach ($cluster in $clusters) {<br />
    "Working on Cluster $cluster"<br />
    $vmhosts = get-vmhost -Location $cluster<br />
    foreach ($vmhost in $vmhosts) {<br />
    "`tWorking on VMHost $vmhost"<br />
        $vmlist = get-vm -location $vmhost<br />
        $totalDisk = 0<br />
        foreach ($vm in $vmlist) {<br />
            $view = $vm | get-View<br />
            foreach ($disk in $view.Guest.Disk) {<br />
                $disksize = ([math]::Round($disk.Capacity/1MB))<br />
                $totaldisk += $disksize<br />
            }<br />
         }<br />
         "`t`tVM size: $totaldisk"<br />
            $obj = new-object PSObject -Property @{<br />
                Cluster = $cluster<br />
                VMHost  = $vmhost<br />
                TotalDiskMB = $totaldisk<br />
            }<br />
         $diskuse += $obj<br />
    }<br />
}</p>
<p>$diskuse | export-csv "OpenFileDiskUse.csv" -NoTypeInformation</pre></p>
<p>With Default settings the magic numbers to look for:</p>
<ul>
<li>ESXi 4.x - 4TB</li>
<li>ESXi 5.1 - 8TB</li><br />
</ul></p>
